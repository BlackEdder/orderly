context("config")

test_that("read", {
  cfg <- orderly_config("example")
  expect_is(cfg, "orderly_config")

  ## default destination database:
  expect_equal(cfg$destination$driver, c("RSQLite", "SQLite"))
  expect_equal(cfg$destination$args, list(dbname = "orderly.sqlite"))

  dat <- orderly_db_args(cfg$destination, cfg)
  expect_identical(dat$driver, RSQLite::SQLite)
  expect_identical(dat$args$dbname, file.path(cfg$path, "orderly.sqlite"))
})

test_that("environment variables", {
  path <- tempfile()
  dir.create(path)

  dat <- list(source = list(driver = "RSQLite::SQLite",
                            host = "OURHOST",
                            port = "OURPORT",
                            user = "OURUSER",
                            dbname = "OURDBNAME",
                            password = "$OURPASSWORD"))
  writeLines(yaml::as.yaml(dat), path_orderly_config_yml(path))

  cfg <- orderly_config(path)

  expect_error(orderly_db_args(cfg$database$source, cfg),
               "Environment variable 'OURPASSWORD' is not set")

  dat <- withr::with_envvar(
    c(OURPASSWORD = "foo"),
    orderly_db_args(cfg$database$source, cfg))
  expect_equal(dat$args$password, "foo")
  expect_equal(dat$args$host, "OURHOST")
})

test_that("not found", {
  expect_error(orderly_config(tempfile()),
               "Did not find file 'orderly_config.yml' at path")
})

test_that("get: invalid config", {
  expect_error(orderly_config_get(1), "Invalid input")
})

test_that("get: default", {
  cfg <- orderly_config("example")
  oo <- orderly_default_config_set(cfg)
  on.exit(options(oo))

  expect_identical(orderly_default_config(), cfg)
  expect_identical(orderly_config_get(NULL), cfg)

  orderly_default_config_set(NULL)
  expect_error(orderly_default_config(),
               "orderly configuration not found")

  path <- tempfile()
  dir_create(path)
  expect_error(with_wd(path, orderly_default_config(TRUE)),
               "Reached root")
  file.copy(file.path("example/orderly_config.yml"), path)
  cfg2 <- with_wd(path, orderly_default_config(TRUE))
  expect_identical(cfg2$path, normalizePath(path))
})


test_that("minimum orderly version is enforced", {
  path <- tempfile()
  dir.create(path)

  dat <- list(source = list(driver = "RSQLite::SQLite"),
              minimum_orderly_version = "9.9.9")
  writeLines(yaml::as.yaml(dat), path_orderly_config_yml(path))

  expect_error(orderly_config(path),
               "Orderly version '9.9.9' is required, but only",
               fixed = TRUE)
})


test_that("minimum version is a less than relationship", {
  path <- tempfile()
  dir.create(path)

  dat <- list(source = list(driver = "RSQLite::SQLite"),
              minimum_orderly_version = as.character(packageVersion("orderly")))
  writeLines(yaml::as.yaml(dat), path_orderly_config_yml(path))
  cfg <- orderly_config(path)
  expect_is(cfg, "orderly_config")
  expect_equal(cfg$minimum_orderly_version, dat$minimum_orderly_version)
})


test_that("support declaring api server", {
  path <- tempfile()
  dir.create(path)
  dat <- list(source = list(driver = "RSQLite::SQLite"),
              remote = list(
                main = list(
                  driver = "orderly::orderly_remote_path",
                  primary = TRUE,
                  master_only = TRUE,
                  args = list(path = path)),
                other = list(
                  driver = "orderly::orderly_remote_path",
                  args = list(path = path))))
  writeLines(yaml::as.yaml(dat), path_orderly_config_yml(path))
  cfg <- orderly_config(path)

  expect_is(cfg$remote, "list")
  expect_equal(cfg$remote$main$args,
               list(path = path, name = "main"))

  cfg <- withr::with_envvar(
    c("ORDERLY_API_SERVER_IDENTITY" = "main"),
    orderly_config(path))
  expect_equal(cfg$remote_identity, "main")
  expect_true(cfg$server_options$primary)
  expect_true(cfg$server_options$master_only)

  cfg <- withr::with_envvar(
    c("ORDERLY_API_SERVER_IDENTITY" = "other"),
    orderly_config(path))
  expect_equal(cfg$remote_identity, "other")
  expect_false(cfg$server_options$primary)
  expect_false(cfg$server_options$master_only)

  cfg <- withr::with_envvar(
    c("ORDERLY_API_SERVER_IDENTITY" = NA),
    orderly_config(path))
  expect_null(cfg$remote_identity)
  expect_null(cfg$server_options)

  withr::with_envvar(
    c("ORDERLY_API_SERVER_IDENTITY" = "something-else"),
    expect_error(
      orderly_config(path)$remote_identity,
      "remote_identity must be one of 'main', 'other'"))
})


test_that("api server has only one primary", {
  path <- tempfile()
  dir.create(path)
  dat <- list(source = list(driver = "RSQLite::SQLite"),
              remote = list(
                main = list(
                  driver = "orderly::orderly_remote_path",
                  primary = TRUE,
                  args = list(path = path)),
                other = list(
                  driver = "orderly::orderly_remote_path",
                  primary = TRUE,
                  args = list(path = path))))

  writeLines(yaml::as.yaml(dat), path_orderly_config_yml(path))
  expect_error(
    orderly_config(path),
    "At most one remote can be listed as primary but here 2 are")
  dat$remote$other$primary <- FALSE
  writeLines(yaml::as.yaml(dat), path_orderly_config_yml(path))
  cfg <- orderly_config(path)
  expect_true(cfg$remote$main$primary)
  expect_false(cfg$remote$other$primary)
})

test_that("remote parse check", {
  path <- tempfile()
  dir.create(path)
  dat <- list(source = list(driver = "RSQLite::SQLite"),
              remote = list(
                myhost = list(
                  driver = "orderly::orderly_remote_path",
                  primary = TRUE,
                  args = list(path = path),
                  master_only = "yeah")))
  writeLines(yaml::as.yaml(dat), path_orderly_config_yml(path))
  expect_error(orderly_config(path),
               "'.+/orderly_config.yml:remote:myhost:master_only' must be logical")
})

test_that("no global folder", {
  path <- prepare_orderly_example("global")
  # now we break the orderly_config.yml
  path_config <- file.path(path, "orderly_config.yml")
  config_lines <- readLines(path_config)
  # we know the final line (line six) is the global resource folder
  # so set it to something invalid
  config_lines[6] <- "  invalid_directory"
  writeLines(config_lines, path_config)

  expect_error(
    orderly_config(path = path),
    "global resource does not exist: 'invalid_directory'",
    fixed = TRUE
  )
})


test_that("vault configuration", {
  path <- prepare_orderly_example("minimal")
  path_config <- file.path(path, "orderly_config.yml")
  text <- readLines(path_config)

  expect_null(orderly_config(path = path)$vault_server)

  url <- "https://vault.example.com"
  writeLines(c(text, sprintf("vault_server: %s", url)), path_config)
  expect_equal(orderly_config(path = path)$vault_server, url)

  writeLines(c(text, sprintf("vault_server: %s", TRUE)), path_config)
  expect_error(orderly_config(path = path),
               "orderly_config.yml:vault_server' must be character",
               fixed = TRUE)
})


test_that("can't use both database and source sections", {
  path <- prepare_orderly_example("minimal")
  path_config <- file.path(path, "orderly_config.yml")
  txt <- readLines(path_config)
  dat <- list(source = list(driver = "RSQLite::SQLite",
                            dbname = "source.sqlite"))
  writeLines(c(txt, yaml::as.yaml(dat)), path_config)
  expect_error(orderly_config(path),
               "Both 'database' and 'source' fields may not be used",
               fixed = TRUE)
})


test_that("can read a configuration with no database", {
  path <- prepare_orderly_example("db0")
  config <- orderly_config(path)
  expect_false("database" %in% names(config))
})
